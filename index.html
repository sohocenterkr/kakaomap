<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>매장 위치 지도</title>
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=46b58eca50897ba6771c3e40f3c7b8a4&libraries=services" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
        }
        body {
            padding: 10px;
            max-width: 100%;
            overflow-x: hidden;
        }
        h1 {
            font-size: 20px;
            margin-bottom: 15px;
            text-align: center;
        }
        #map {
            width: 100%;
            height: 60vh;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .controls {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 8px;
        }
        .file-input {
            width: 100%;
            padding: 10px 0;
        }
        button {
            background-color: #FEE500;
            color: #000;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
        }
        button:active {
            background-color: #E6CF00;
        }
        .store-list {
            margin-top: 20px;
            height: 30vh;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }
        .store-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .store-item:last-child {
            border-bottom: none;
        }
        .store-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .store-address {
            font-size: 14px;
            color: #666;
        }
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <h1>매장 위치 지도</h1>
    
    <div class="controls">
        <input type="file" id="csv-file" class="file-input" accept=".csv">
        <button id="load-map">지도에 표시하기</button>
    </div>
    
    <div id="map"></div>
    
    <div class="loading" id="loading">처리 중...</div>
    
    <div class="store-list" id="store-list">
        <p style="text-align: center; padding: 20px;">CSV 파일을 업로드하세요</p>
    </div>

    <script>
        // 전역 변수
        let map;
        let markers = [];
        let stores = [];
        let geocoder;
        
        // 페이지 로드 시 지도 초기화
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                try {
                    if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined') {
                        alert('카카오맵 API 로드에 실패했습니다. 페이지를 새로고침 해주세요.');
                        return;
                    }
                    
                    initMap();
                    document.getElementById('load-map').addEventListener('click', processCSV);
                } catch (e) {
                    console.error('카카오맵 초기화 오류:', e);
                    alert('카카오맵 초기화 중 오류가 발생했습니다: ' + e.message);
                }
            }, 1000); // API가 완전히 로드될 시간을 주기 위해 약간의 지연 추가
        });
        
        // 지도 초기화
        function initMap() {
            const container = document.getElementById('map');
            const options = {
                center: new kakao.maps.LatLng(37.5665, 126.9780), // 서울 중심
                level: 8
            };
            
            map = new kakao.maps.Map(container, options);
            geocoder = new kakao.maps.services.Geocoder();
        }
        
        // CSV 파일 처리
        function processCSV() {
            const fileInput = document.getElementById('csv-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('CSV 파일을 선택해주세요.');
                return;
            }
            
            // 로딩 표시
            document.getElementById('loading').style.display = 'block';
            document.getElementById('store-list').innerHTML = '';
            
            // 기존 마커 제거
            clearMarkers();
            
            // CSV 파싱
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(results) {
                    if (results.errors && results.errors.length > 0) {
                        console.error('CSV 파싱 오류:', results.errors);
                        alert('CSV 파일 파싱 중 오류가 발생했습니다.');
                    }
                    
                    stores = results.data.filter(row => Object.keys(row).length > 1); // 빈 행 필터링
                    console.log('로드된 데이터:', stores);
                    processStores();
                },
                error: function(error) {
                    alert('CSV 파일 처리 중 오류가 발생했습니다: ' + error);
                    document.getElementById('loading').style.display = 'none';
                }
            });
        }
        
        // 매장 데이터 처리
        function processStores() {
            if (stores.length === 0) {
                alert('데이터가 없습니다.');
                document.getElementById('loading').style.display = 'none';
                return;
            }
            
            console.log('처리할 데이터 수:', stores.length);
            
            // 첫 번째 행의 키를 확인하여 주소와 이름 필드 추측
            const firstRow = stores[0];
            const keys = Object.keys(firstRow);
            console.log('데이터 필드:', keys);
            
            let nameField = '';
            let addressField = '';
            
            // 필드명 추측
            for (const key of keys) {
                const keyLower = key.toLowerCase();
                if (keyLower.includes('이름') || keyLower.includes('name') || keyLower.includes('상호') || keyLower === '매장명') {
                    nameField = key;
                }
                if (keyLower.includes('주소') || keyLower.includes('address')) {
                    addressField = key;
                }
            }
            
            // 필드를 찾지 못했다면 첫 번째와 두 번째 필드를 사용
            if (!nameField && keys.length > 0) {
                nameField = keys[0];
            }
            if (!addressField && keys.length > 1) {
                addressField = keys[1];
            }
            
            console.log('이름 필드:', nameField, '주소 필드:', addressField);
            
            // 스토어 목록 생성
            let storeListHTML = '';
            
            // 비동기 주소 처리를 위한 카운터
            let processedCount = 0;
            let successCount = 0;
            let errorCount = 0;
            
            stores.forEach((store, index) => {
                if (!store[nameField] || !store[addressField]) {
                    processedCount++;
                    console.log(`데이터 누락 [${index}]:`, store);
                    if (processedCount >= stores.length) {
                        finishProcessing(successCount, errorCount);
                    }
                    return;
                }
                
                const name = store[nameField];
                const address = store[addressField];
                
                storeListHTML += `
                    <div class="store-item" data-index="${index}">
                        <div class="store-name">${name}</div>
                        <div class="store-address">${address}</div>
                    </div>
                `;
                
                // 주소를 좌표로 변환
                geocoder.addressSearch(address, function(result, status) {
                    processedCount++;
                    
                    if (status === kakao.maps.services.Status.OK) {
                        successCount++;
                        const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                        
                        // 마커 생성
                        const marker = new kakao.maps.Marker({
                            map: map,
                            position: coords
                        });
                        
                        // 정보창 생성
                        const infowindow = new kakao.maps.InfoWindow({
                            content: `<div style="padding:5px;font-size:12px;width:150px;">${name}<br><span style="font-size:11px;color:#666;">${address}</span></div>`
                        });
                        
                        // 마커 클릭 이벤트
                        kakao.maps.event.addListener(marker, 'click', function() {
                            // 다른 모든 인포윈도우 닫기
                            markers.forEach(m => m.infowindow.close());
                            infowindow.open(map, marker);
                        });
                        
                        // 마커 저장
                        markers.push({
                            marker: marker,
                            infowindow: infowindow,
                            coords: coords,
                            index: index
                        });
                        
                        // 첫 번째 마커로 지도 중심 이동
                        if (markers.length === 1) {
                            map.setCenter(coords);
                        }
                    } else {
                        errorCount++;
                        console.error(`주소 변환 실패 [${index}]: ${address}, 상태: ${status}`);
                    }
                    
                    // 모든 주소 처리가 완료되면 로딩 숨김
                    if (processedCount >= stores.length) {
                        finishProcessing(successCount, errorCount);
                    }
                });
            });
            
            // 스토어 목록 업데이트
            const storeListElement = document.getElementById('store-list');
            storeListElement.innerHTML = storeListHTML;
            
            // 스토어 목록 아이템 클릭 이벤트
            const storeItems = document.querySelectorAll('.store-item');
            storeItems.forEach(item => {
                item.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    const markerInfo = markers.find(m => m.index === index);
                    
                    if (markerInfo) {
                        // 다른 모든 인포윈도우 닫기
                        markers.forEach(m => m.infowindow.close());
                        
                        map.setCenter(markerInfo.coords);
                        map.setLevel(3);
                        markerInfo.infowindow.open(map, markerInfo.marker);
                    }
                });
            });
        }
        
        // 처리 완료 함수
        function finishProcessing(successCount, errorCount) {
            document.getElementById('loading').style.display = 'none';
            
            // 처리 결과 메시지
            const message = `처리 완료: ${successCount}개 성공, ${errorCount}개 실패`;
            console.log(message);
            
            // 알림 표시
            if (errorCount > 0) {
                alert(`${message}\n일부 주소를 지도에 표시하지 못했습니다.`);
            }
            
            // 모든 마커가 보이도록 지도 범위 설정
            if (markers.length > 0) {
                setBounds();
            } else if (successCount === 0) {
                alert('지도에 표시할 위치 정보가 없습니다. CSV 파일의 주소 형식을 확인해주세요.');
            }
        }
        
        // 마커 모두 제거
        function clearMarkers() {
            markers.forEach(markerInfo => {
                markerInfo.marker.setMap(null);
            });
            markers = [];
        }
        
        // 모든 마커가 보이도록 지도 범위 설정
        function setBounds() {
            const bounds = new kakao.maps.LatLngBounds();
            
            markers.forEach(markerInfo => {
                bounds.extend(markerInfo.coords);
            });
            
            map.setBounds(bounds);
        }
    </script>
</body>
</html>
